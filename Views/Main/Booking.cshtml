@section InlineStyles
{
    <style type="text/css">
        .picker__holder {
            width: 400px;
        }

        .picker--time > .picker__holder {
            width: 200px;
        }

        .picker__select--year, .picker__select--month {
            height: 2.5em;
        }

        .recap {
            color: #f7ad00 !important;
            font-size: 18px !important;
            line-height: 20px !important;
        }

        .has-error {
            color: #D91E18;
            margin-top: 10px;
            margin-bottom: 5px;
            display: none;
        }
    </style>
}
<!--Banner Start-->
<div class="cp_inner-banner">
    <img src="~/images/banner/sub-banner.jpg" alt="">
    <!--Inner Banner Holder Start-->
    <div class="cp-inner-banner-holder">
        <div class="container">
            <h2>RÉSERVEZ EN LIGNE</h2>
            <!--Breadcrumb Start-->
            <ul class="breadcrumb">
                <li><a href="@Url.Action("GetHomePage", "Main")">Accueil</a></li>
                <li class="active">Prix et Réservation</li>
            </ul><!--Breadcrumb End-->
        </div>

    </div><!--Inner Banner Holder End-->
</div>
<!--Banner End-->
<!--Booking Section Start-->
<section class="cp-booking-section pd-b80" style="min-height:500px;">
    <div class="container">
        <div class="cp-heading-style1">
        </div>
        <!--Booking Form Outer Start-->
        <div class="cp-booking-form-outer">

            <div id="simulation-form" class="row">
                <div class="col-md-3 col-sm-12">
                    <div class="booking-inner-holder">
                        <label><i class="fa fa-map-marker"></i>&nbsp; Départ</label>
                        <input id="departure" class="form-control" type="text" name="Departure" />
                        <span id="departure-error" class="has-error">Champs requis</span>
                    </div>
                </div>
                <div class="col-md-3 col-sm-12">
                    <div class="booking-inner-holder">
                        <label><i class="fa fa-map-marker"></i>&nbsp; Destination</label>
                        <input id="destination" class="form-control" type="text" name="Destination" />
                        <span id="destination-error" class="has-error">Champs requis</span>
                    </div>
                </div>
                <div class="col-md-2 col-sm-12">
                    <div class="booking-inner-holder">
                        <label><i class="fa fa-users"></i>&nbsp; Voyageurs</label>
                        <input id="travelersNumber" class="form-control" type="number" step="1" name="TravelersNumber" placeholder="Nombre" />
                        <span id="travelersNumber-error" class="has-error">Champs requis</span>
                        <span id="travelersNumber-min-error" class="has-error">Le nombre minimum autorisé : 1 voyageur</span>
                        <span id="travelersNumber-max-error" class="has-error">Vous avez dépassé le nombre maximum des voyageurs : 8</span>
                        <span id="travelersNumber-float-error" class="has-error">Format non valide</span>
                    </div>
                </div>
                <div class="col-md-2 col-sm-12">
                    <div class="booking-inner-holder">
                        <label><i class="fa fa-calendar"></i>&nbsp; Date</label>
                        <input id="date" class="form-control" type="text" name="name" placeholder="Indiquez une date">
                        <span id="date-error" class="has-error">Champs requis</span>
                    </div>
                </div>
                <div class="col-md-2 col-sm-12">
                    <div class="booking-inner-holder">
                        <label><i class="fa fa-clock-o"></i>&nbsp; Heure</label>
                        <input id="time" class="form-control" type="text" name="name" placeholder="Indiquez une heure">
                        <span id="time-error" class="has-error">Champs requis</span>
                    </div>
                </div>
            </div>
            <div id="alert" class="row" style="display:none;">
                <div class="col-md-12 col-sm-12">
                    <div id="note">
                        Adresse non valide.
                    </div>
                </div>

            </div>
            <div id="simulation-block" class="row" style="display:none;">
                <div class="col-md-6 col-sm-12">
                    <div id="mapPanel" style="width: 500px; height: 500px">
                    </div>
                </div>
                <div id="simulation-recap" class="col-md-6 col-sm-12">
                    <div class="booking-inner-holder">
                        <div class="form-group">
                            <label class="control-label col-md-4"><i class="fa fa-map-marker"></i>&nbsp; Départ.</label>
                            <label id="departurePanel" class="control-label col-md-8 recap"></label>
                        </div>
                    </div>
                    <div class="booking-inner-holder">
                        <div class="form-group">
                            <label class="control-label col-md-4"><i class="fa fa-map-marker"></i>&nbsp; Destination.</label>
                            <label id="destinationPanel" class="control-label col-md-8 recap"></label>
                        </div>
                    </div>
                    <div class="booking-inner-holder">
                        <div class="form-group">
                            <label class="control-label col-md-4"><i class="fa fa-users"></i>&nbsp; Voyageurs</label>
                            <label id="travelersNumberPanel" class="control-label col-md-8 recap"></label>
                        </div>
                    </div>
                    <div class="booking-inner-holder">
                        <div class="form-group">
                            <label class="control-label col-md-4"><i class="fa fa-calendar"></i>&nbsp; Date</label>
                            <label id="datePanel" class="control-label col-md-8 recap"></label>
                        </div>
                    </div>
                    <div class="booking-inner-holder">
                        <div class="form-group">
                            <label class="control-label col-md-4"><i class="fa fa-arrows-h"></i>&nbsp; Distance</label>
                            <label id="distancePanel" class="control-label col-md-8 recap"></label>
                        </div>
                    </div>
                    <div class="booking-inner-holder">
                        <div class="form-group">
                            <label class="control-label col-md-4"><i class="fa fa-clock-o"></i>&nbsp; Temps</label>
                            <label id="durationPanel" class="control-label col-md-8 recap"></label>
                        </div>
                    </div>
                    <div class="booking-inner-holder">
                        <div class="form-group">
                            <label class="control-label col-md-4"><i class="fa fa-eur"></i>&nbsp; Coût estimatif</label>
                            <label id="costPanel" class="control-label col-md-8 recap"></label>
                        </div>
                    </div>
                    <div class="booking-inner-holder">
                        <button id="new-simulation-btn" class="cp-btn-style1" type="button">Nouvelle simulation</button>
                        <button id="order-btn" class="cp-btn-style1" type="button">Je réserve</button>
                    </div>
                </div>
                <div id="order-form" class="col-md-6 col-sm-12" style="display:none;" @*padding-top: 40px;*@>
                    <div class="booking-inner-holder">
                        <label>Nom <span style="color:#D91E18;">*</span></label>
                        <input id="lastName" class="form-control" type="text" name="LastName" />
                        <span id="lastName-error" class="has-error">Champs requis</span>
                    </div>
                    <div class="booking-inner-holder">
                        <label>Prénom <span style="color:#D91E18;">*</span></label>
                        <input id="firstName" class="form-control" type="text" name="FirstName" />
                        <span id="firstName-error" class="has-error">Champs requis</span>
                    </div>
                    <div class="booking-inner-holder">
                        <label>Email <span style="color:#D91E18;">*</span></label>
                        <input id="email" class="form-control" type="text" name="Email" />
                        <span id="email-error" class="has-error">Champs requis</span>
                    </div>
                    <div class="booking-inner-holder">
                        <label>Tél <span style="color:#D91E18;">*</span></label>
                        <input id="phone" class="form-control" type="text" name="Phone" />
                        <span id="phone-error" class="has-error">Champs requis</span>
                    </div>
                    <div class="booking-inner-holder">
                        <label>Mode de Paiement <span style="color:#D91E18;">*</span></label>
                        <select id="payment-method" name="PaymentMethod" class="form-control">
                            <option value="Espèces" selected>Espèces</option>
                            <option value="Carte de crédit">Carte de crédit</option>
                            <option value="Chèque">Chèque</option>
                        </select>
                        <span id="payment-method-error" class="has-error">Champs requis</span>
                    </div>
                    <div class="booking-inner-holder">
                        <button type="button" id="cancel-btn" class="cp-btn-style1">Annuler</button>
                        <button type="button" id="submit-btn" class="cp-btn-style1">Confirmer</button>
                    </div>
                </div>
            </div>
            <br />
            <div class="row">
                <div class="col-md-4 col-md-offset-4 col-sm-12 text-center">
                    <button type="button" id="simulation-btn" class="cp-btn-style1">Simulation</button>
                </div>
            </div>
            <div id="loader" class="row osahanloading" style="display:none; margin-top:170px;">
            </div>
        </div>
        <!--Booking Form Outer End-->
        <!--Reservation Box Start-->
        <div id="success-confirmation" class="cp-reservation-box" style="display:none;">
            <h3><i class="fa fa-check success-icon"></i></h3>
            <h3 style="color:#26A69A;">Votre réservation a été reçue avec succès.</h3>
        </div>
        <div id="error-confirmation" class="cp-reservation-box" style="display:none;">
            <h3><i class="fa fa-exclamation error-icon"></i></h3>
            <h3 style="color:#E26A6A;">Une erreur est survenue.Veuillez réessayer ultérieurement</h3>
        </div>
        <!--Reservation Box End-->
    </div>
</section>
<!--Booking Section End-->

@section InlineScripts
{
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3iUlbCze4JkdtOMxM5IyvwMiwPRMu8Jg&libraries=places"></script>
    <script type="text/javascript">

        var directionsService = new google.maps.DirectionsService();
        var directionsDisplay;
        var map;

        google.maps.event.addDomListener(window, 'load', function () {
            new google.maps.places.Autocomplete(document.getElementById('departure'), {
                tyspes: ['geocode'],
                componentRestrictions: {
                    country: 'FR',
                }
            });
            new google.maps.places.Autocomplete(document.getElementById('destination'), {
                tyspes: ['geocode'],
                componentRestrictions: {
                    country: 'FR',
                }
            });
            directionsDisplay = new google.maps.DirectionsRenderer({ 'draggable': true });

        });

        function getRoute() {

            var bordeaux = new google.maps.LatLng(44.837789, -0.579180);

            var mapOptions = {
                zoom: 7,
                center: bordeaux
            };

            map = new google.maps.Map(document.getElementById('mapPanel'), mapOptions);
            directionsDisplay.setMap(map);

            var request = {
                origin: document.getElementById("departure").value,
                destination: document.getElementById("destination").value,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function (response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                }
            });

            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [document.getElementById("departure").value],
                destinations: [document.getElementById("destination").value],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, function (response, status) {
                try {
                    if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                        
                        departurePanel.innerHTML = document.getElementById("departure").value;
                        destinationPanel.innerHTML = document.getElementById("destination").value;
                        travelersNumberPanel.innerHTML = document.getElementById("travelersNumber").value;
                        datePanel.innerHTML = document.getElementById("date").value + ' à ' + document.getElementById("time").value;
                        distancePanel.innerHTML = response.rows[0].elements[0].distance.text;
                        durationPanel.innerHTML = response.rows[0].elements[0].duration.text;

                        let durationSec = response.rows[0].elements[0].duration.value;
                        let durationMin = durationSec / 60;
                        let spDt = document.getElementById("date").value.split('/');
                        let spTm = document.getElementById("time").value.split(':');
                        let dateDepart = new Date(spDt[2], spDt[1], spDt[0], spTm[0], spTm[1]);
                        let distance = (response.rows[0].elements[0].distance.value / 1000);
                        let prix = 5; // prix de de prise en charge 5 euros

                        prix = prix + (1.5 * distance); // Ajouter le prix par km, 1.5 euros par min
                        prix = prix + (0.45 * durationMin); // Ajouter le prix par min, 0.45 euros par min
                                                
                        if (dateDepart.getHours() >= 20 || dateDepart.getHours() <= 4) { // De 20h00 à 4h59 on ajoute 20% au prix
                            prix = prix + (prix * 0.2)
                            console.log('Prix soir')
                        }

                        costPanel.innerHTML = (new Number(prix)).toFixed(2) + ' &euro;';

                        $('#loader').hide();
                        $('#simulation-block').fadeIn('slow');
                        google.maps.event.trigger(map, "resize");

                    } else {
                        $('#loader').hide();
                        $('#alert').show();
                        $('#simulation-form').show();
                        $('#simulation-btn').show();
                    }
                } catch (e) {
                    $('#loader').hide();
                    $('#alert').show();
                    $('#simulation-form').show();
                    $('#simulation-btn').show();
                }

            });
        }

        $(function () {

            $('.order-now').on('click', function () {
                $(document).scrollTop($("#simulation-form").offset().top);
            });

            // Datepicker
            $('#date').pickadate({
                monthsFull: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'],
                weekdaysShort: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
                // Buttons
                today: 'Aujourd\'hui',
                close: 'Fermer',
                format: 'dd/mm/yyyy',
                selectMonths: true,
                selectYears: 100,
                editable: false,
                min: new Date()
            });

            // Time picker
            $('#time').pickatime({
                format: 'H:i',
                formatLabel: '<b>H</b>:i',
                interval: 5,
                clear: 'Effacer'
            })

            // Email mask
            //$('#email').inputmask({
            //    mask: "*{1,20}[.*{1,20}][.*{1,20}][.*{1,20}]@@*{1,20}[.*{2,6}][.*{1,2}]",
            //    greedy: false,
            //    onBeforePaste: function (pastedValue, opts) {
            //        pastedValue = pastedValue.toLowerCase();
            //        return pastedValue.replace("mailto:", "");
            //    },
            //    definitions: {
            //        '*': {
            //            validator: "[0-9A-Za-z!#$%&'*+/=?^_`{|}~\-]",
            //            cardinality: 1,
            //            casing: "lower"
            //        }
            //    }
            //});

            // Phone mask
            $("#phone").inputmask("99 99 99 99 99");

            $('#simulation-btn').on('click', function () {
                $('#error-confirmation').hide();
                if (!validateSimulationForm())
                    return;
                $('#simulation-form').hide();
                $('#simulation-btn').hide();
                $('#alert').hide();
                $('#loader').show();
                getRoute();

            });

            $('#new-simulation-btn').on('click', function () {
                $('#departure').val('');
                $('#destination').val('');
                $('#travelersNumber').val('');
                $('#date').val('');
                $('#time').val('');
                $('#simulation-block').hide();
                $('#simulation-form').fadeIn('slow');
                $('#simulation-btn').fadeIn('slow');
            });

            $('#order-btn').on('click', function () {
                $('#simulation-recap').hide();
                $('#order-form').fadeIn('slow');
            });

            $('#cancel-btn').on('click', function () {
                $('#order-form').hide();
                $('#simulation-recap').fadeIn('slow');
            });

            $('#submit-btn').on('click', function () {
                if (!validateOrderForm())
                    return;
                $('#simulation-block').hide();
                $('#loader').show();
                $.ajax({
                    url: window.origin + '/Order',
                    type: 'POST',
                    data: {
                        Departure: $('#departure').val(),
                        Destination: $('#destination').val(),
                        TravelersNumber: $('#travelersNumber').val(),
                        Date: $('#date').val(),
                        Time: $('#time').val(),
                        LastName: $('#lastName').val(),
                        FirstName: $('#firstName').val(),
                        Email: $('#email').val(),
                        Phone: $('#phone').val(),
                        PaymentMethod: $('#payment-method').val(),
                        EstimatedDistance: $('#distancePanel').html(),
                        EstimatedDuration: $('#durationPanel').html(),
                        EstimatedCost: $('#costPanel').html()
                    },
                    success: function (response, statut) {
                        $('#success-confirmation').show();
                    },
                    error: function (rejection, statut, erreur) {
                        $('#error-confirmation').show();
                        $('#simulation-form').show();
                        $('#simulation-btn').show();
                    },
                    complete: function (response, statut) {
                        $('#loader').hide();
                    }
                });
            });

            function validateSimulationForm() {
                var isValid = true;

                if ($('#departure').val() == '') {
                    $('#departure-error').show();
                    isValid = false;
                } else {
                    $('#departure-error').hide();
                }

                if ($('#destination').val() == '') {
                    $('#destination-error').show();
                    isValid = false;
                } else {
                    $('#destination-error').hide();
                }

                if ($('#travelersNumber').val() == '') {
                    $('#travelersNumber-error').show();
                    isValid = false;
                } else {
                    $('#travelersNumber-error').hide();
                }

                if ($('#travelersNumber').val() != '' && $('#travelersNumber').val() <= 0) {
                    $('#travelersNumber-min-error').show();
                    isValid = false;
                } else {
                    $('#travelersNumber-min-error').hide();
                }

                if ($('#travelersNumber').val() != '' && $('#travelersNumber').val() >= 8) {
                    $('#travelersNumber-max-error').show();
                    isValid = false;
                } else {
                    $('#travelersNumber-max-error').hide();
                }

                if ($('#travelersNumber').val() != '' && $('#travelersNumber').val() % 1 != 0) {
                    $('#travelersNumber-float-error').show();
                    isValid = false;
                } else {
                    $('#travelersNumber-float-error').hide();
                }

                if ($('#date').val() == '') {
                    $('#date-error').show();
                    isValid = false;
                } else {
                    $('#date-error').hide();
                }

                if ($('#time').val() == '') {
                    $('#time-error').show();
                    isValid = false;
                } else {
                    $('#time-error').hide();
                }

                return isValid;
            }

            function validateOrderForm() {
                var isValid = true;

                if ($('#firstName').val() == '') {
                    $('#firstName-error').show();
                    isValid = false;
                } else {
                    $('#firstName-error').hide();
                }

                if ($('#lastName').val() == '') {
                    $('#lastName-error').show();
                    isValid = false;
                } else {
                    $('#lastName-error').hide();
                }

                if ($('#email').val() == '') {
                    $('#email-error').show();
                    isValid = false;
                } else {
                    $('#email-error').hide();
                }

                if ($('#phone').val() == '') {
                    $('#phone-error').show();
                    isValid = false;
                } else {
                    $('#phone-error').hide();
                }

                if ($('#payment-method').val() == '' || $('#payment-method').val() == null) {
                    $('#payment-method-error').show();
                    isValid = false;
                } else {
                    $('#payment-method-error').hide();
                }

                return isValid;
            }

        });

    </script>
}

